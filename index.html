<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universal DocViewer</title>
  <style>
    :root {
      --bg-app: #1e1e1e;
      --bg-panel: #252526;
      --bg-active: #1e1e1e;
      --text-primary: #d4d4d4;
      --text-dim: #858585;
      --accent: #007acc;
      --border: #3e3e42;
      --error: #f48771;
      --font-ui: "Inter", "Segoe UI", "San Francisco", sans-serif;
      --font-code: "Fira Code", "JetBrains Mono", Consolas, monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-ui);
      background: var(--bg-app);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    #app-shell {
      display: grid;
      grid-template-rows: 35px 1fr 22px;
      height: 100vh;
      overflow: hidden;
    }

    header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    header .brand {
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.02em;
    }

    header button {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-dim);
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    header button:hover { background: rgba(255,255,255,0.04); color: var(--text-primary); }

    main {
      display: grid;
      grid-template-rows: 40px 1fr;
      overflow: hidden;
    }

    .tab-bar {
      display: flex;
      align-items: flex-end;
      background: var(--bg-app);
      border-bottom: 1px solid var(--border);
      padding: 0 8px;
      gap: 4px;
      position: relative;
    }

    .tabs-container {
      display: flex;
      gap: 4px;
      overflow: hidden;
      flex: 1;
      height: 100%;
      align-items: flex-end;
    }

    .tab {
      position: relative;
      padding: 8px 18px 8px 14px;
      border: 1px solid transparent;
      border-bottom: none;
      background: transparent;
      color: var(--text-dim);
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      user-select: none;
      min-width: 120px;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
      transition: all 0.15s ease;
    }

    .tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }

    .tab.active {
      color: var(--accent);
      background: var(--bg-active);
      border-color: var(--border);
      box-shadow: 0 -2px 0 var(--accent) inset;
      z-index: 2;
    }

    .tab .close {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.15s;
      font-weight: 700;
    }

    .tab:hover .close, .tab.active .close { opacity: 1; }

    .tab .dirty-dot {
      width: 6px;
      height: 6px;
      background: #e6b400;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .tab-overflow { padding: 8px; cursor: pointer; color: var(--text-dim); position: relative; }
    .overflow-menu { position: absolute; right: 0; top: 100%; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; display: none; flex-direction: column; min-width: 200px; z-index: 10; }
    .overflow-menu button { border: none; background: none; color: var(--text-primary); padding: 8px 12px; text-align: left; cursor: pointer; }
    .overflow-menu button:hover { background: rgba(255,255,255,0.05); }

    .workspace {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: 100%;
      background: var(--bg-panel);
      overflow: hidden;
    }

    .sidebar {
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .sidebar h4 {
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 11px;
    }

    .sidebar .file-item {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-dim);
      transition: background 0.15s, color 0.15s;
      font-size: 13px;
    }

    .sidebar .file-item:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }

    .content-region { position: relative; background: #111; overflow: hidden; }

    .content-scroll { height: 100%; overflow: auto; }

    .welcome-screen { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: radial-gradient(circle at 20% 20%, #252526 0%, #1e1e1e 65%); }
    .welcome-card { background: rgba(37,37,38,0.9); border: 1px solid var(--border); border-radius: 12px; padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .welcome-card h1 { font-size: 24px; margin-bottom: 8px; }
    .welcome-card p { color: var(--text-dim); margin-bottom: 18px; }
    .action-card { border: 1px solid var(--border); padding: 12px; border-radius: 10px; cursor: pointer; transition: border 0.15s, transform 0.15s; background: #1e1e1e; }
    .action-card:hover { border-color: var(--accent); transform: translateY(-2px); }

    .statusbar { display: flex; align-items: center; gap: 12px; padding: 0 12px; background: var(--bg-app); border-top: 1px solid var(--border); color: var(--text-dim); font-size: 11px; }
    .statusbar .spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    .statusbar .spinner.active { display: inline-block; }
    .statusbar .detail { margin-left: auto; font-family: var(--font-code); }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 80; animation: fade 0.2s ease; }
    .modal { width: 520px; max-width: calc(100% - 40px); background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 12px 40px rgba(0,0,0,0.4); animation: rise 0.25s ease; }
    .modal header { padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); font-weight: 600; }
    .modal header button { background: none; border: none; color: var(--text-dim); cursor: pointer; }
    .modal header button:hover { color: var(--error); }
    #modal-body { padding: 16px; color: var(--text-primary); font-size: 14px; }
    .modal footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
    .modal footer button { border: 1px solid var(--border); background: transparent; color: var(--text-primary); padding: 8px 14px; border-radius: 6px; cursor: pointer; }
    .modal footer button:last-child { background: var(--accent); border-color: var(--accent); color: #fff; }

    .context-menu { position: fixed; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 6px 0; display: none; flex-direction: column; min-width: 180px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 120; }
    .context-menu button { border: none; background: none; color: var(--text-primary); padding: 8px 12px; text-align: left; cursor: pointer; font-size: 13px; }
    .context-menu button:hover { background: rgba(255,255,255,0.04); }

    .command-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; padding-top: 80px; z-index: 90; }
    .command-panel { width: 580px; max-width: calc(100% - 40px); background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 14px 40px rgba(0,0,0,0.5); }
    .command-panel input { padding: 12px; background: #1e1e1e; border: none; color: var(--text-primary); font-size: 15px; width: 100%; }
    .command-panel ul { list-style: none; max-height: 320px; overflow-y: auto; }
    .command-panel li { padding: 10px 14px; border-top: 1px solid var(--border); cursor: pointer; color: var(--text-primary); }
    .command-panel li:hover { background: rgba(255,255,255,0.04); }

    .toast-container { position: fixed; right: 16px; bottom: 16px; z-index: 150; display: flex; flex-direction: column; gap: 8px; }
    .toast { background: var(--bg-panel); border-left: 4px solid var(--accent); padding: 10px 12px; border-radius: 6px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); font-size: 13px; color: #fff; }

    .drag-overlay { position: fixed; inset: 0; display: none; background: rgba(0,0,0,0.5); z-index: 70; align-items: center; justify-content: center; }
    .dropzone { border: 2px dashed var(--border); padding: 30px 40px; border-radius: 12px; text-align: center; background: rgba(37,37,38,0.9); }

    .global-search { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 620px; max-width: calc(100% - 40px); background: var(--bg-panel); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 110; }
    .global-search header { padding: 12px 14px; border-bottom: 1px solid var(--border); font-weight: 600; }
    .global-search input { padding: 10px 12px; background: #1e1e1e; border: 1px solid var(--border); color: var(--text-primary); margin: 12px; border-radius: 8px; }
    .search-results { max-height: 320px; overflow: auto; padding: 0 12px 12px; }
    .search-group { margin-bottom: 12px; }
    .search-group h5 { font-size: 12px; color: var(--text-dim); margin-bottom: 6px; }
    .search-hit { padding: 8px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; cursor: pointer; background: #1e1e1e; }
    .search-hit strong { color: var(--accent); }

    .diff-view { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); height: 60vh; }
    .diff-pane { overflow: auto; padding: 12px; background: #111; font-family: var(--font-code); font-size: 13px; white-space: pre; }
    .diff-added { background: #1f3b24; }
    .diff-removed { background: #402020; }

    .resizer { width: 4px; cursor: col-resize; background: var(--bg-panel); }

    @media (max-width: 900px) {
      .workspace { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
    @keyframes rise { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
  <div id="app-shell">
    <header>
      <div class="brand">Universal DocViewer</div>
      <button id="open-btn">Abrir</button>
      <button id="save-btn">Guardar</button>
      <button id="settings-btn">Ajustes</button>
      <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
        <span id="session-info">Sesión segura</span>
      </div>
    </header>
    <main>
        <div class="tab-bar">
        <div class="tabs-container" id="tabs"></div>
        <div class="tab-overflow" id="tab-overflow">[...]
          <div class="overflow-menu" id="overflow-menu"></div>
        </div>
      </div>
      <div class="workspace">
        <aside class="sidebar" id="sidebar">
          <section>
            <h4>Archivos</h4>
            <div id="file-list"></div>
          </section>
          <section>
            <h4>Acciones</h4>
            <div class="file-item" data-action="new-md">Nuevo Markdown</div>
            <div class="file-item" data-action="new-code">Nuevo Código</div>
            <div class="file-item" data-action="new-json">Nuevo JSON</div>
          </section>
        </aside>
        <section class="content-region">
          <div class="content-scroll" id="content"></div>
          <div class="welcome-screen" id="welcome">
            <div class="welcome-card">
              <div>
                <h1>Bienvenido</h1>
                <p>Visualiza, edita y convierte documentos en un entorno seguro.</p>
                <div class="action-card" id="quick-open">Abrir archivo local</div>
                <div class="action-card" id="quick-restore">Restaurar sesión</div>
              </div>
              <div>
                <h4 style="color:var(--text-dim); margin-bottom:10px;">Recientes</h4>
                <div id="recent-list" style="display:grid; gap:8px;"></div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <footer class="statusbar">
      <div class="spinner" id="loader"></div>
      <div id="status-text">Listo</div>
      <div class="detail" id="status-detail"></div>
    </footer>
  </div>

  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <span id="modal-title">Modal</span>
        <button id="modal-close">×</button>
      </header>
      <div id="modal-body"></div>
      <footer id="modal-actions"></footer>
    </div>
  </div>

  <div class="context-menu" id="context-menu"></div>
  <div class="toast-container" id="toast-container"></div>
  <div class="drag-overlay" id="drag-overlay"><div class="dropzone"><h2>Suelta para abrir</h2></div></div>

  <div class="command-backdrop" id="command-backdrop">
    <div class="command-panel">
      <input type="text" id="command-input" placeholder="Escribe un comando..." />
      <ul id="command-list"></ul>
    </div>
  </div>

  <div class="global-search" id="global-search">
    <header>Buscar en pestañas</header>
    <input type="text" id="search-input" placeholder="Texto a buscar..." />
    <div class="search-results" id="search-results"></div>
  </div>

  <input type="file" id="file-input" class="hidden" multiple>

  <script type="module">
    const CONFIG_KEY = 'app_config';
    const SESSION_KEY = 'session_index';

    class PluginLoader {
      constructor() {
        this.cache = new Map();
        this.sources = {
          pdfjs: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
          pdflib: 'https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js',
          monaco: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs/loader.min.js',
          marked: 'https://cdnjs.cloudflare.com/ajax/libs/marked/11.2.0/marked.min.js',
          dompurify: 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.5/purify.min.js',
          papaparse: 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js',
          mammoth: 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js',
          sheetjs: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
          jsdiff: 'https://cdnjs.cloudflare.com/ajax/libs/diff/5.2.0/diff.min.js',
          pyodide: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js'
        };
      }
      static get instance() {
        if (!window.__pluginLoader) window.__pluginLoader = new PluginLoader();
        return window.__pluginLoader;
      }
      async load(name) {
        if (this.cache.has(name)) return this.cache.get(name);
        const src = this.sources[name];
        if (!src) throw new Error('Plugin no registrado: ' + name);
        UIManager.setLoading(true, `Cargando ${name}...`);
        const promise = new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = () => { UIManager.setLoading(false); resolve(true); };
          s.onerror = (e) => { UIManager.setLoading(false); reject(e); };
          document.head.appendChild(s);
        });
        this.cache.set(name, promise);
        return promise;
      }
    }

    class FileSystem {
      constructor() {
        this.dbName = 'DocViewerDB_v1';
        this.storeName = 'files';
        this.dbPromise = null;
      }
      async init() {
        if (this.dbPromise) return this.dbPromise;
        this.dbPromise = new Promise((resolve, reject) => {
          const req = indexedDB.open(this.dbName, 1);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(this.storeName)) {
              db.createObjectStore(this.storeName, { keyPath: 'id' });
            }
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
        return this.dbPromise;
      }
      async putFile(file) {
        const db = await this.init();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(this.storeName, 'readwrite');
          tx.objectStore(this.storeName).put(file);
          tx.oncomplete = () => resolve(file);
          tx.onerror = () => reject(tx.error);
        });
      }
      async getFile(id) {
        const db = await this.init();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(this.storeName, 'readonly');
          const req = tx.objectStore(this.storeName).get(id);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }
      async deleteFile(id) {
        const db = await this.init();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(this.storeName, 'readwrite');
          tx.objectStore(this.storeName).delete(id);
          tx.oncomplete = () => resolve(true);
          tx.onerror = () => reject(tx.error);
        });
      }
      async listFiles() {
        const db = await this.init();
        return new Promise((resolve, reject) => {
          const tx = db.transaction(this.storeName, 'readonly');
          const req = tx.objectStore(this.storeName).getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      }
      async reset() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.deleteDatabase(this.dbName);
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });
      }
    }

    class UIManager {
      static init(app) {
        this.app = app;
        this.tabsEl = document.getElementById('tabs');
        this.content = document.getElementById('content');
        this.welcome = document.getElementById('welcome');
        this.loader = document.getElementById('loader');
        this.statusText = document.getElementById('status-text');
        this.statusDetail = document.getElementById('status-detail');
        this.contextMenu = document.getElementById('context-menu');
        this.commandBackdrop = document.getElementById('command-backdrop');
        this.commandInput = document.getElementById('command-input');
        this.commandList = document.getElementById('command-list');
        this.searchPanel = document.getElementById('global-search');
        this.searchInput = document.getElementById('search-input');
        this.searchResults = document.getElementById('search-results');
        this.toastContainer = document.getElementById('toast-container');
        this.overflowMenu = document.getElementById('overflow-menu');
        document.getElementById('tab-overflow').addEventListener('click', (e) => {
          e.stopPropagation();
          this.overflowMenu.style.display = this.overflowMenu.style.display === 'flex' ? 'none' : 'flex';
        });
        window.addEventListener('click', () => this.overflowMenu.style.display = 'none');
      }
      static renderTabs(openTabs, activeId) {
        this.tabsEl.innerHTML = '';
        this.overflowMenu.innerHTML = '';
        openTabs.forEach(tab => {
          const el = document.createElement('div');
          el.className = 'tab' + (tab.id === activeId ? ' active' : '');
          el.dataset.id = tab.id;
          el.innerHTML = `${tab.isDirty ? '<span class="dirty-dot"></span>' : ''}${tab.name}<span class="close" aria-label="Cerrar">×</span>`;
          el.addEventListener('click', (e) => {
            if (e.target.classList.contains('close')) return this.app.closeTab(tab.id);
            this.app.activateTab(tab.id);
          });
          el.addEventListener('contextmenu', (e) => this.showContextMenu(e, tab.id));
          this.tabsEl.appendChild(el);
          if (this.tabsEl.scrollWidth > this.tabsEl.clientWidth) {
            const btn = document.createElement('button');
            btn.textContent = tab.name;
            btn.onclick = () => { this.app.activateTab(tab.id); this.overflowMenu.style.display = 'none'; };
            this.overflowMenu.appendChild(btn);
            if (this.tabsEl.contains(el)) this.tabsEl.removeChild(el);
          }
        });
        document.getElementById('tab-overflow').style.display = this.overflowMenu.children.length ? 'block' : 'none';
      }
      static renderContent(tab) {
        this.content.innerHTML = '';
        if (!tab) { this.welcome.style.display = 'flex'; return; }
        this.welcome.style.display = 'none';
        const container = document.createElement('div');
        container.className = 'content-scroll';
        container.dataset.id = tab.id;
        container.appendChild(EditorFactory.render(tab));
        this.content.appendChild(container);
      }
      static updateSidebar(files) {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        files.forEach(f => {
          const item = document.createElement('div');
          item.className = 'file-item';
          item.textContent = f.name;
          item.addEventListener('click', () => this.app.openFromStore(f.id));
          list.appendChild(item);
        });
      }
      static setLoading(active, detail='') {
        this.loader.classList.toggle('active', active);
        this.statusText.textContent = active ? 'Cargando...' : 'Listo';
        this.statusDetail.textContent = detail;
      }
      static toast(msg) {
        const div = document.createElement('div');
        div.className = 'toast';
        div.textContent = msg;
        this.toastContainer.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      }
      static showContextMenu(e, id) {
        e.preventDefault();
        const menu = this.contextMenu;
        menu.innerHTML = '';
        ['Cerrar pestaña','Cerrar otras','Duplicar','Renombrar','Ver propiedades'].forEach(action => {
          const btn = document.createElement('button');
          btn.textContent = action;
          btn.onclick = () => { menu.style.display='none'; this.app.handleContext(action, id); };
          menu.appendChild(btn);
        });
        menu.style.display = 'flex';
        menu.style.left = `${e.clientX}px`;
        menu.style.top = `${e.clientY}px`;
        document.addEventListener('click', () => menu.style.display='none', { once: true });
      }
      static openCommandPalette(commands) {
        this.commandList.innerHTML='';
        commands.forEach(cmd => {
          const li = document.createElement('li');
          li.textContent = cmd.label;
          li.onclick = () => { cmd.run(); this.toggleCommand(false); };
          this.commandList.appendChild(li);
        });
        this.toggleCommand(true);
      }
      static renderCommandFilter(query) {
        [...this.commandList.children].forEach(li => {
          li.style.display = li.textContent.toLowerCase().includes(query.toLowerCase()) ? 'block' : 'none';
        });
      }
      static toggleCommand(show) {
        this.commandBackdrop.style.display = show ? 'flex' : 'none';
        if (show) { this.commandInput.value=''; this.commandInput.focus(); }
      }
      static showSearch(show) {
        this.searchPanel.style.display = show ? 'flex' : 'none';
        if (show) { this.searchInput.value=''; this.searchInput.focus(); }
      }
      static renderSearchResults(results) {
        this.searchResults.innerHTML='';
        results.forEach(group => {
          const block = document.createElement('div');
          block.className = 'search-group';
          block.innerHTML = `<h5>${group.name}</h5>`;
          group.matches.forEach(hit => {
            const row = document.createElement('div');
            row.className = 'search-hit';
            row.innerHTML = `<strong>L${hit.line}</strong> — ${hit.preview}`;
            row.onclick = () => this.app.jumpTo(group.id, hit.line);
            block.appendChild(row);
          });
          this.searchResults.appendChild(block);
        });
      }
    }

    class EditorFactory {
      static render(tab) {
        const wrapper = document.createElement('div');
        wrapper.style.height = '100%';
        wrapper.style.display = 'grid';
        wrapper.style.gridTemplateRows = 'auto 1fr';
        const toolbar = document.createElement('div');
        toolbar.style.padding = '8px 12px';
        toolbar.style.borderBottom = '1px solid var(--border)';
        toolbar.style.background = 'var(--bg-panel)';
        toolbar.innerHTML = `<span style="color:var(--text-dim)">${tab.type}</span>`;
        const buttonWrap = document.createElement('div');
        buttonWrap.style.display = 'flex';
        buttonWrap.style.gap = '8px';
        buttonWrap.style.float = 'right';
        if (tab.type === 'markdown') {
          buttonWrap.innerHTML = '<button data-md="insert-img">Insertar imagen</button>';
        }
        if (tab.type === 'code') {
          buttonWrap.innerHTML = '<button data-run="js">Run JS</button><button data-run="py">Run Python</button><button data-run="java" disabled>Run Java</button>';
        }
        toolbar.appendChild(buttonWrap);
        wrapper.appendChild(toolbar);

        const area = document.createElement('div');
        area.style.height = '100%';
        area.style.overflow = 'auto';

        if (tab.type === 'pdf') {
          area.innerHTML = '<div class="pdf-virtual" style="position:relative;"></div><div class="pdf-overlay" style="position:absolute; inset:0; pointer-events:none;"></div>';
          this.loadPDF(tab, area);
        } else if (tab.type === 'markdown') {
          const split = document.createElement('div');
          split.className = 'split-view';
          split.innerHTML = `
            <div class="split-pane editor-pane" style="font-family:var(--font-code);"><textarea style="width:100%; height:100%; background:#1e1e1e; color:#fff; border:none;"></textarea></div>
            <div class="split-resizer" draggable="true"></div>
            <div class="split-pane preview-pane"></div>`;
          this.bindSplit(split, tab);
          area.appendChild(split);
        } else if (tab.type === 'code') {
          const wrap = document.createElement('div');
          wrap.style.display = 'grid';
          wrap.style.gridTemplateRows = '1fr 120px';
          wrap.style.height = '100%';
          const code = document.createElement('div');
          code.id = `monaco-${tab.id}`;
          code.style.height = '100%';
          const consoleView = document.createElement('pre');
          consoleView.style.margin = '0';
          consoleView.style.padding = '8px';
          consoleView.style.background = '#111';
          consoleView.style.borderTop = '1px solid var(--border)';
          consoleView.style.overflow = 'auto';
          consoleView.textContent = 'Consola lista';
          wrap.appendChild(code);
          wrap.appendChild(consoleView);
          area.appendChild(wrap);
          this.loadMonaco(tab, code, consoleView);
        } else if (tab.type === 'json') {
          const tree = document.createElement('div');
          tree.className = 'json-tree';
          tree.textContent = 'Cargando árbol JSON...';
          area.appendChild(tree);
          this.renderJsonTree(tab, tree);
        } else if (tab.type === 'office') {
          const container = document.createElement('div');
          container.style.padding = '12px';
          container.textContent = 'Preparando documento...';
          area.appendChild(container);
          this.renderOffice(tab, container);
        } else if (tab.type === 'csv') {
          const container = document.createElement('div');
          container.innerHTML = '<div style="padding:8px;"><input id="csv-search" placeholder="Buscar" style="width:200px; padding:6px; background:#1e1e1e; color:#fff; border:1px solid var(--border);" /></div><div class="csv-grid"></div>';
          area.appendChild(container);
          this.renderCsv(tab, container);
        } else if (tab.type === 'image') {
          const img = document.createElement('img');
          const url = URL.createObjectURL(new Blob([tab.blob]));
          tab.objectUrl = url;
          img.src = url;
          img.style.maxWidth = '100%';
          img.style.maxHeight = '100%';
          img.style.objectFit = 'contain';
          img.style.transition = 'transform 0.2s';
          let scale = 1;
          img.addEventListener('wheel', (e) => {
            if (!e.ctrlKey) return;
            e.preventDefault();
            scale += e.deltaY * -0.001;
            scale = Math.min(Math.max(.2, scale), 5);
            img.style.transform = `scale(${scale})`;
          });
          area.appendChild(img);
        } else if (tab.type === 'binary') {
          const bin = document.createElement('div');
          bin.style.padding = '10px';
          bin.style.fontFamily = 'var(--font-code)';
          bin.style.overflow = 'auto';
          area.appendChild(bin);
          this.renderBinary(tab, bin);
        } else {
          area.innerHTML = '<div style="padding:20px;">Visor binario/imagen pendiente de carga.</div>';
        }
        wrapper.appendChild(area);
        return wrapper;
      }
      static async loadPDF(tab, container) {
        await PluginLoader.instance.load('pdfjs');
        const pdfData = new Uint8Array(tab.blob);
        if (window.pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
        const holder = container.querySelector('.pdf-virtual');
        holder.innerHTML = '';
        const renderPage = async (pageNo) => {
          const page = await pdf.getPage(pageNo);
          const viewport = page.getViewport({ scale: 1.2 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width; canvas.height = viewport.height;
          canvas.style.width = '100%'; canvas.style.marginBottom = '12px';
          holder.appendChild(canvas);
          await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
        };
        const renderWindow = () => {
          holder.innerHTML = '';
          const start = Math.max(1, Math.floor(container.scrollTop / 800));
          const end = Math.min(pdf.numPages, start + 20);
          for (let i=start;i<=end;i++) renderPage(i);
        };
        renderWindow();
        container.addEventListener('scroll', () => renderWindow());
        const overlay = container.querySelector('.pdf-overlay');
        overlay.style.pointerEvents = 'auto';
        overlay.addEventListener('dblclick', (e) => {
          const note = document.createElement('div');
          note.contentEditable = true;
          note.style.position = 'absolute';
          note.style.left = e.offsetX + 'px';
          note.style.top = e.offsetY + 'px';
          note.style.background = 'rgba(0,0,0,0.6)';
          note.style.padding = '4px 6px';
          note.style.borderRadius = '4px';
          note.textContent = 'Nota';
          overlay.appendChild(note);
          tab.annotations = tab.annotations || [];
          tab.annotations.push({ x: e.offsetX, y: e.offsetY, text: 'Nota' });
        });
      }
      static bindSplit(split, tab) {
        const [left, handle, right] = split.children;
        left.querySelector('textarea').value = tab.content || '';
        const render = async () => {
          await PluginLoader.instance.load('marked');
          await PluginLoader.instance.load('dompurify');
          const raw = left.querySelector('textarea').value;
          const html = DOMPurify.sanitize(marked.parse(raw));
          right.innerHTML = html;
          tab.content = raw;
          tab.isDirty = true;
        };
        left.querySelector('textarea').addEventListener('input', () => render());
        handle.addEventListener('dblclick', () => { left.style.flex = '0 0 50%'; });
        const mobileToggle = document.createElement('button');
        mobileToggle.textContent = 'Toggle Preview';
        mobileToggle.style.position = 'absolute';
        mobileToggle.style.right = '12px';
        mobileToggle.style.bottom = '12px';
        mobileToggle.style.zIndex = '100';
        mobileToggle.onclick = () => {
          right.style.display = right.style.display === 'none' ? 'block' : 'none';
        };
        split.appendChild(mobileToggle);
        const insertBtn = split.parentElement.querySelector('[data-md="insert-img"]');
        if (insertBtn) insertBtn.onclick = () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              const textarea = left.querySelector('textarea');
              const pos = textarea.selectionStart;
              const before = textarea.value.substring(0,pos);
              const after = textarea.value.substring(pos);
              textarea.value = `${before}![](${reader.result})${after}`;
              textarea.dispatchEvent(new Event('input'));
            };
            reader.readAsDataURL(file);
          };
          input.click();
        };
        render();
        let startX = 0, startW = 0;
        handle.addEventListener('dragstart', e => { startX = e.clientX; startW = left.offsetWidth; });
        handle.addEventListener('drag', e => {
          if (!e.clientX) return;
          const delta = e.clientX - startX;
          const percent = ((startW + delta) / split.offsetWidth) * 100;
          left.style.flex = `0 0 ${percent}%`;
        });
      }
      static async loadMonaco(tab, el, consoleView) {
        await PluginLoader.instance.load('monaco');
        const loader = window.require;
        loader.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.0/min/vs' } });
        loader(['vs/editor/editor.main'], () => {
          const editor = monaco.editor.create(el, {
            value: tab.content || '',
            language: tab.lang || 'javascript',
            theme: 'vs-dark',
            minimap: { enabled: false },
            wordWrap: 'off',
            fontLigatures: true,
            automaticLayout: true
          });
          const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
          if (cfg.zoomLevel) editor.updateOptions({ fontSize: 14 * (cfg.zoomLevel/100) });
          tab.editor = editor;
          editor.onDidChangeModelContent(() => { tab.content = editor.getValue(); tab.isDirty = true; });
          const runner = (type) => this.runCode(type, tab, consoleView);
          el.closest('.content-scroll').previousSibling?.querySelectorAll('[data-run]').forEach(btn => {
            btn.onclick = () => runner(btn.dataset.run);
          });
        });
      }
      static renderJsonTree(tab, container) {
        let data;
        try { data = JSON.parse(tab.content || '{}'); }
        catch { container.textContent = 'JSON inválido'; return; }
        const build = (obj, depth=0) => {
          const ul = document.createElement('ul');
          for (const key in obj) {
            const li = document.createElement('li');
            li.className = 'json-node';
            const val = obj[key];
            if (typeof val === 'object' && val !== null) {
              li.innerHTML = `<span class="toggle">▸</span><span class="key">${key}</span>`;
              const child = build(val, depth+1);
              child.style.display = 'none';
              li.appendChild(child);
              li.querySelector('.toggle').onclick = () => {
                const open = child.style.display === 'block';
                child.style.display = open ? 'none' : 'block';
                li.querySelector('.toggle').textContent = open ? '▸' : '▾';
              };
            } else {
              li.innerHTML = `<span class="key">${key}</span>: <span class="value">${val}</span> <span class="type">(${typeof val})</span>`;
            }
            ul.appendChild(li);
          }
          return ul;
        };
        container.innerHTML = '';
        container.appendChild(build(data));
      }
      static async renderOffice(tab, container) {
        const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
        const hasApi = !!cfg.apiKeyOfuscada;
        const msg = document.createElement('div');
        msg.textContent = hasApi ? 'Usando API remoto para mayor fidelidad...' : 'Modo de baja fidelidad (Sin conexión). Configure API Key en ajustes para calidad original.';
        msg.style.marginBottom = '10px';
        container.innerHTML = '';
        container.appendChild(msg);
        const ext = tab.ext;
        if (ext === 'doc' || ext === 'docx') {
          await PluginLoader.instance.load('mammoth');
          const result = await window.mammoth.convertToHtml({ arrayBuffer: tab.blob });
          const html = document.createElement('div');
          html.innerHTML = result.value;
          container.appendChild(html);
        } else {
          await PluginLoader.instance.load('sheetjs');
          const workbook = XLSX.read(new Uint8Array(tab.blob), { type: 'array' });
          const first = workbook.SheetNames[0];
          const html = XLSX.utils.sheet_to_html(workbook.Sheets[first]);
          const div = document.createElement('div');
          div.innerHTML = html;
          container.appendChild(div);
        }
      }
      static async renderCsv(tab, container) {
        await PluginLoader.instance.load('papaparse');
        const parsed = Papa.parse(tab.content || '', { header: false });
        let rows = parsed.data.filter(r => r.length);
        const grid = container.querySelector('.csv-grid');
        const renderTable = (set=rows) => {
          grid.innerHTML = '';
          const table = document.createElement('table');
          table.style.width = '100%';
          table.style.borderCollapse = 'collapse';
          const head = document.createElement('thead');
          const headerRow = document.createElement('tr');
          const cols = Math.max(...set.map(r => r.length));
          for (let i=0;i<cols;i++) {
            const th = document.createElement('th');
            th.textContent = `Col ${i+1}`;
            th.style.cursor = 'pointer';
            th.style.borderBottom = '1px solid var(--border)';
            th.onclick = () => {
              const asc = th.dataset.sort !== 'asc';
              th.dataset.sort = asc ? 'asc' : 'desc';
              rows = rows.sort((a,b) => (a[i]||'').localeCompare(b[i]||'') * (asc ? 1 : -1));
              renderTable(rows);
            };
            headerRow.appendChild(th);
          }
          head.appendChild(headerRow);
          table.appendChild(head);
          const body = document.createElement('tbody');
          set.forEach(r => {
            const tr = document.createElement('tr');
            r.forEach(cell => {
              const td = document.createElement('td');
              td.textContent = cell;
              td.style.borderBottom = '1px solid var(--border)';
              td.style.padding = '6px';
              tr.appendChild(td);
            });
            body.appendChild(tr);
          });
          table.appendChild(body);
          grid.appendChild(table);
        };
        renderTable(rows);
        container.querySelector('#csv-search').oninput = (e) => {
          const q = e.target.value.toLowerCase();
          const filtered = rows.filter(r => r.some(c => String(c).toLowerCase().includes(q)));
          renderTable(filtered);
        };
      }
      static renderBinary(tab, container) {
        const bytes = new Uint8Array(tab.blob);
        const perRow = 16;
        let html = '<table style="width:100%; border-collapse:collapse;">';
        for (let i=0;i<bytes.length;i+=perRow) {
          html += '<tr>';
          html += `<td style="padding:4px; color:var(--text-dim);">${i.toString(16).padStart(8,'0')}</td>`;
          let hex = '', ascii='';
          for (let j=0;j<perRow;j++) {
            const val = bytes[i+j];
            if (isNaN(val)) continue;
            hex += val.toString(16).padStart(2,'0') + ' ';
            ascii += val > 31 && val < 127 ? String.fromCharCode(val) : '.';
          }
          html += `<td style="padding:4px; font-family:var(--font-code);">${hex}</td>`;
          html += `<td style="padding:4px; font-family:var(--font-code);">${ascii}</td>`;
          html += '</tr>';
        }
        html += '</table>';
        container.innerHTML = html;
      }
      static async runCode(kind, tab, consoleView) {
        const log = (...args) => {
          const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
          consoleView.textContent += `\n${msg}`;
          consoleView.scrollTop = consoleView.scrollHeight;
        };
        if (kind === 'js') {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          document.body.appendChild(iframe);
          const script = iframe.contentDocument.createElement('script');
          iframe.contentWindow.console.log = (...args) => log(...args);
          script.textContent = tab.editor?.getValue() || tab.content || '';
          iframe.contentDocument.body.appendChild(script);
          setTimeout(() => iframe.remove(), 1000);
        } else if (kind === 'py') {
          await PluginLoader.instance.load('pyodide');
          const pyodide = await loadPyodide({ stdout: log, stderr: log });
          try { await pyodide.runPythonAsync(tab.editor?.getValue() || tab.content || ''); }
          catch (err) { log(err.message); }
        }
      }
    }

    class App {
      constructor() {
        this.fs = new FileSystem();
        UIManager.init(this);
        this.config = this.loadConfig();
        this.openTabs = [];
        this.activeTab = null;
        this.bindUI();
        this.restoreSession();
      }
      bindUI() {
        document.getElementById('open-btn').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').addEventListener('change', (e) => this.handleFiles(e.target.files));
        document.getElementById('save-btn').onclick = () => this.saveActive();
        document.getElementById('settings-btn').onclick = () => this.showSettings();
        document.getElementById('quick-open').onclick = () => document.getElementById('file-input').click();
        document.getElementById('quick-restore').onclick = () => this.restoreSession();
        document.getElementById('modal-close').onclick = () => this.toggleModal(false);
        document.getElementById('command-input').addEventListener('keydown', (e) => { if (e.key==='Escape') UIManager.toggleCommand(false); });
        window.addEventListener('keydown', (e) => this.handleKeys(e));
        window.addEventListener('dragover', (e)=>{ e.preventDefault(); document.getElementById('drag-overlay').style.display='flex'; });
        window.addEventListener('dragleave', ()=>{ document.getElementById('drag-overlay').style.display='none'; });
        window.addEventListener('drop', (e)=>{ e.preventDefault(); document.getElementById('drag-overlay').style.display='none'; if (e.dataTransfer.files.length) this.handleFiles(e.dataTransfer.files); });
        window.addEventListener('beforeunload', () => this.persistSession());
        window.addEventListener('blur', () => this.autoSave());
        this.content = document.getElementById('content');
      }
      async handleFiles(fileList) {
        for (const file of fileList) {
          if (file.size > 10 * 1024 * 1024) {
            const proceed = confirm('Archivo grande. Entrar en modo valiente?');
            if (!proceed) continue;
          }
          const id = crypto.randomUUID();
          const blob = await file.arrayBuffer();
          const meta = { id, name: file.name, type: this.detectType(file.name), blob, lastModified: file.lastModified, isDirty: false };
          await this.fs.putFile(meta);
          this.openTab(meta, blob);
        }
        UIManager.updateSidebar(await this.fs.listFiles());
      }
      detectType(name) {
        const ext = name.split('.').pop().toLowerCase();
        if (ext === 'pdf') return 'pdf';
        if (ext === 'md') return 'markdown';
        if (['js','ts','html','css','java','py'].includes(ext)) return 'code';
        if (['json','csv'].includes(ext)) return ext;
        if (['doc','docx','xls','xlsx'].includes(ext)) return 'office';
        if (['jpg','png','gif','webp','svg'].includes(ext)) return 'image';
        return 'binary';
      }
      openTab(meta, buffer) {
        const tab = {
          id: meta.id,
          name: meta.name,
          type: meta.type,
          ext: meta.name.split('.').pop().toLowerCase(),
          blob: buffer,
          content: this.decode(meta, buffer),
          isDirty: meta.isDirty,
          lang: meta.name.split('.').pop()
        };
        this.openTabs.push(tab);
        this.activateTab(tab.id);
        this.persistSession();
      }
      decode(meta, buffer) {
        if (['pdf','binary','image','office'].includes(meta.type)) return buffer;
        const dec = new TextDecoder();
        return dec.decode(buffer);
      }
      activateTab(id) {
        this.activeTab = id;
        const tab = this.openTabs.find(t => t.id === id);
        UIManager.renderTabs(this.openTabs, id);
        UIManager.renderContent(tab);
        this.persistSession();
      }
      closeTab(id) {
        const tab = this.openTabs.find(t => t.id === id);
        if (!tab) return;
        URL.revokeObjectURL(tab.objectUrl);
        this.openTabs = this.openTabs.filter(t => t.id !== id);
        this.activeTab = this.openTabs.at(-1)?.id || null;
        UIManager.renderTabs(this.openTabs, this.activeTab);
        UIManager.renderContent(this.openTabs.find(t => t.id === this.activeTab));
        this.persistSession();
      }
      async openFromStore(id) {
        const meta = await this.fs.getFile(id);
        if (!meta) return;
        this.openTab(meta, meta.blob);
      }
      async restoreSession() {
        const ids = JSON.parse(localStorage.getItem(SESSION_KEY) || '[]');
        const files = await this.fs.listFiles();
        UIManager.updateSidebar(files);
        ids.forEach(id => {
          const meta = files.find(f => f.id === id);
          if (meta) this.openTab(meta, meta.blob);
        });
        if (this.openTabs.length === 0) UIManager.renderContent(null);
      }
      persistSession() {
        localStorage.setItem(SESSION_KEY, JSON.stringify(this.openTabs.map(t => t.id)));
      }
      async saveActive() {
        const tab = this.openTabs.find(t => t.id === this.activeTab);
        if (!tab) return;
        const blob = tab.type === 'pdf' || tab.type === 'binary' ? new Blob([tab.blob]) : new Blob([tab.content]);
        await this.fs.putFile({ id: tab.id, name: tab.name, type: tab.type, blob, lastModified: Date.now(), isDirty: false });
        tab.isDirty = false;
        UIManager.renderTabs(this.openTabs, this.activeTab);
        UIManager.toast('Guardado');
      }
      autoSave() { this.saveActive(); }
      showSettings() {
        const body = document.getElementById('modal-body');
        const actions = document.getElementById('modal-actions');
        body.innerHTML = `
          <label style="display:block; margin-bottom:10px;">Tema
            <select id="theme-select" style="width:100%; padding:8px; margin-top:6px; background:#1e1e1e; color:#fff; border:1px solid var(--border);">
              <option value="dark">Oscuro</option>
            </select>
          </label>
          <label style="display:block; margin-bottom:10px;">Zoom editor (%)
            <input type="number" id="zoom-level" value="${this.config.zoomLevel||100}" style="width:100%; padding:8px; margin-top:6px; background:#1e1e1e; color:#fff; border:1px solid var(--border);" />
          </label>
          <label style="display:block; margin-bottom:10px;">API Key
            <input type="text" id="api-key" value="${this.config.apiKeyOfuscada||''}" placeholder="Opcional" style="width:100%; padding:8px; margin-top:6px; background:#1e1e1e; color:#fff; border:1px solid var(--border);" />
          </label>
          <div style="margin-top:10px;">
            <button id="panic" style="width:100%; background: #3b0d0d; border-color:#5c1a1a; color:#fff; padding:10px;">Botón del pánico</button>
          </div>`;
        actions.innerHTML = '<button id="close-settings">Cerrar</button><button id="save-settings">Guardar</button>';
        document.getElementById('panic').onclick = () => this.factoryReset();
        document.getElementById('close-settings').onclick = () => this.toggleModal(false);
        document.getElementById('save-settings').onclick = () => {
          this.config.zoomLevel = Number(document.getElementById('zoom-level').value)||100;
          this.config.apiKeyOfuscada = document.getElementById('api-key').value;
          this.saveConfig();
          this.toggleModal(false);
        };
        this.toggleModal(true, 'Ajustes');
      }
      loadConfig() {
        try { return JSON.parse(localStorage.getItem(CONFIG_KEY)) || {}; }
        catch { return {}; }
      }
      saveConfig() {
        localStorage.setItem(CONFIG_KEY, JSON.stringify(this.config));
      }
      toggleModal(show, title='') {
        document.getElementById('modal-backdrop').style.display = show ? 'flex' : 'none';
        document.getElementById('modal-title').textContent = title;
      }
      async factoryReset() {
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'Confirmar (5)';
        confirmBtn.disabled = true;
        const actions = document.getElementById('modal-actions');
        actions.appendChild(confirmBtn);
        let counter = 5;
        const timer = setInterval(() => {
          counter -=1;
          confirmBtn.textContent = `Confirmar (${counter})`;
          if (counter === 0) { confirmBtn.disabled = false; clearInterval(timer); }
        }, 1000);
        confirmBtn.onclick = async () => {
          await this.fs.reset();
          localStorage.clear();
          location.reload();
        };
      }
      handleContext(action, id) {
        if (action === 'Cerrar pestaña') this.closeTab(id);
        else if (action === 'Cerrar otras') this.openTabs.filter(t => t.id !== id).forEach(t => this.closeTab(t.id));
        else if (action === 'Duplicar') {
          const tab = this.openTabs.find(t => t.id === id);
          if (tab) this.openTab({ ...tab, id: crypto.randomUUID() }, tab.blob || tab.content);
        } else if (action === 'Renombrar') {
          const newName = prompt('Nuevo nombre');
          if (newName) {
            const tab = this.openTabs.find(t => t.id === id);
            if (tab) { tab.name = newName; tab.isDirty = true; UIManager.renderTabs(this.openTabs, this.activeTab); }
          }
        } else if (action === 'Ver propiedades') {
          const tab = this.openTabs.find(t => t.id === id);
          if (tab) alert(`Nombre: ${tab.name}\nTipo: ${tab.type}\nModificado: ${new Date(tab.lastModified||Date.now()).toLocaleString()}`);
        }
      }
      handleKeys(e) {
        if (e.ctrlKey && e.key === 'p') { e.preventDefault(); this.printActive(); }
        if (e.ctrlKey && e.key === 'f') { e.preventDefault(); this.search(); }
        if (e.ctrlKey && e.key === 'k') { e.preventDefault(); UIManager.openCommandPalette(this.commandList()); }
        if (e.ctrlKey && e.key === 's') { e.preventDefault(); this.saveActive(); }
        if (e.ctrlKey && e.key === '+') { e.preventDefault(); this.adjustZoom(0.1); }
        if (e.ctrlKey && e.key === '-') { e.preventDefault(); this.adjustZoom(-0.1); }
      }
      adjustZoom(delta) {
        const tab = this.openTabs.find(t => t.id === this.activeTab);
        if (tab?.editor && tab.type === 'code') {
          const current = tab.editor.getOption(monaco.editor.EditorOption.fontSize) || 14;
          tab.editor.updateOptions({ fontSize: current + delta * 10 });
        }
      }
      printActive() {
        const tab = this.openTabs.find(t => t.id === this.activeTab);
        if (!tab) return;
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.width = '0';
        iframe.style.height = '0';
        document.body.appendChild(iframe);
        iframe.contentDocument.write(`<pre style="font-family:${'var(--font-code)'};">${(tab.content || '')}</pre>`);
        iframe.contentWindow.print();
        setTimeout(()=> iframe.remove(), 1000);
      }
      search() {
        UIManager.showSearch(true);
        UIManager.renderSearchResults(this.openTabs.filter(t => typeof t.content === 'string').map(t => ({
          id: t.id,
          name: t.name,
          matches: (t.content.match(/.{0,20}query.{0,20}/g) || []).map((m, i) => ({ line: i+1, preview: m }))
        })));
        document.getElementById('search-input').oninput = (e) => {
          const q = e.target.value.toLowerCase();
          const results = this.openTabs.filter(t => typeof t.content === 'string' && t.content.toLowerCase().includes(q)).map(t => {
            const matches = [];
            t.content.split(/\n/).forEach((line, idx) => { if (line.toLowerCase().includes(q)) matches.push({ line: idx+1, preview: line.trim() }); });
            return { id: t.id, name: t.name, matches };
          }).filter(r => r.matches.length);
          UIManager.renderSearchResults(results);
        };
      }
      jumpTo(id, line) {
        this.activateTab(id);
        // TODO: scroll to specific line depending on viewer type
      }
      commandList() {
        return [
          { label: 'Nueva pestaña Markdown', run: () => this.createUntitled('markdown') },
          { label: 'Nueva pestaña Código', run: () => this.createUntitled('code') },
          { label: 'Comparar archivos (Diff)', run: () => this.showDiff() }
        ];
      }
      createUntitled(type) {
        const id = crypto.randomUUID();
        this.openTabs.push({ id, name: `Sin título.${type}`, type, content: '', isDirty: true, lang: type==='code'?'javascript':undefined });
        this.activateTab(id);
      }
      showDiff() {
        PluginLoader.instance.load('jsdiff').then(() => {
          const body = document.getElementById('modal-body');
          body.innerHTML = '<div class="diff-view"><div class="diff-pane" id="diff-left"></div><div class="diff-pane" id="diff-right"></div></div>';
          const actions = document.getElementById('modal-actions');
          actions.innerHTML = '<button id="close-diff">Cerrar</button>';
          document.getElementById('close-diff').onclick = () => this.toggleModal(false);
          const [a,b] = this.openTabs.slice(0,2);
          if (a && b) {
            const diff = Diff.createTwoFilesPatch(a.name,b.name,a.content||'',b.content||'');
            document.getElementById('diff-left').textContent = diff;
          }
          this.toggleModal(true, 'Comparador');
        });
      }
    }

    window.onload = () => new App();
  </script>
</body>
</html>
